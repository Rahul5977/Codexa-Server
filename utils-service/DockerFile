# ==========================================
# STAGE 1: The Builder (Compiles TypeScript)
# ==========================================
FROM node:20-alpine AS builder

# Accept DATABASE_URL as build arg
ARG DATABASE_URL
ENV DATABASE_URL=${DATABASE_URL}

WORKDIR /app

# 1. Copy Root Configs
# We need the root package.json to understand workspaces
COPY package.json package-lock.json ./

# 2. Copy the Shared Library (db-service)
# We copy it to /app/db-service inside the container
COPY db-service ./db-service

# 3. Copy the Service we are building
# (CHANGE THIS for other services -> e.g., COPY utils-service ./utils-service)
COPY utils-service ./utils-service

# 4. Install Dependencies
# This runs from Root and links @codexa/db to utils-service
RUN npm ci

# 5. Build the Shared Library (Generate Prisma Client)
WORKDIR /app/db-service
RUN npx prisma generate
RUN npm run build

# 6. Build the Utils Service
WORKDIR /app/utils-service
RUN npm run build

# ==========================================
# STAGE 2: The Runner (Production Image)
# ==========================================
FROM node:20-alpine AS runner
WORKDIR /app

# 1. Copy necessary runtime files
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

# 2. Copy the built DB Library
COPY --from=builder /app/db-service/dist ./db-service/dist
COPY --from=builder /app/db-service/package.json ./db-service/package.json
COPY --from=builder /app/db-service/prisma ./db-service/prisma

# 3. Copy the built utils Service
# (CHANGE THIS for other services)
COPY --from=builder /app/utils-service/dist ./utils-service/dist
COPY --from=builder /app/utils-service/package.json ./utils-service/package.json
COPY --from=builder /app/utils-service/node_modules ./utils-service/node_modules

# 4. Start the App
# (CHANGE THIS for other services)
WORKDIR /app/utils-service
CMD ["node", "dist/index.js"]